---
title: "Extremos"
subtitle: "CE-312 - Estatística Computacional"
author: 
  - name: Ellen Jieyi Zhou
  - name: Leonardo Gonçalves Fischer
  - name: Mariana Cardozo Lick
    affiliation: UFPR
date: "`r Sys.Date()`"
code-fold: true
code-line-numbers: true
execute: 
  warning: false
  error: false
editor: visual
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    df_print: kable
editor_options: 
  markdown: 
    wrap: 72
---

## 1. Introdução

Seja uma amostra aleatória $(Y_1, Y_2, ..., Y_n)$ de uma população com
distribuição comum $F$. Sabe-se que para amostras suficientemente
grandes e certas condições de regularidade a distribuição amostral da
média $\bar Y$ converge para uma distribuição normal, indiferentemente
da distribuição $F$ da variável. Mas o que acontece com a distribuição
do máximo $Y_M = \text{max}(Y_1, Y_2, ..., Y_n)?$

Estudar o comportamento do máximo pode ser útil em diversos contextos,
particularmente no cenário ambiental, em que há interesse em estimar os
valores máximos de temperatura, nível de poluição e precipitação por
exemplo.

### 1.1 Justificativa

A princípio, é simples obter a distribuição exata do máximo a partir da
distribuição $F$ da variável:

$$
\begin{align*}
P(Y_M \leq y) &= P(Y_1 \leq y, ..., Y_n \leq y) \\
&= P(Y_1 \leq y)...P(Y_n \leq y) \ \ \ (Y_1,...,Y_n \ \ \text{independentes})\\
&= \{F(y)\}^n \tag{1}
\end{align*} 
$$

Entretanto, há situações em que a equação em (1) é difícil de ser obtida
analiticamente, como no caso da distribuição normal. Além disso, nem
sempre a distribuição $F$ e/ou seus parâmetros são conhecidos, e
estimá-los poderia levar a erros significativos. Desse modo, estimar a
distribuição de $Y_M$ diretamente, desconsiderando a distribuição da
população, é mais adequado.

### 1.2 Distribuição amostral do máximo

Então, qual a distribuição amostral do máximo? Seria a distribuição
Normal? Para verificar isso o seguinte algoritmo pode ser usado:

1.  Gere uma amostra de tamanho n da distribuição Normal(0,1).
2.  Obtenha o valor máximo da amostra.
3.  Repita os passos 1 e 2 muitas vezes.
4.  Analise o comportamento da distribuição amostral do máximo, usando
    qq-plots (qq-norm).

Este algoritmo será usado para diferentes tamanhos de amostra (n = 10, n
= 100, n = 1000 e n = 10000), a fim de averiguar se as distribuições
amostrais se aproximam da normalidade para valores crescentes de n. No
fim, será demonstrado que a distribuição amostral do máximo $Y_M$ não é
normal, possuindo uma assimetria positiva significativa.

### 1.3 Distribuição de Gumbel

Nesse contexto, uma aproximação melhor é dada pela distribuição de
*Gumbel*, que faz parte de uma família de distribuições conhecida como
*distribuição de valor extremo generalizado*. Sua função de distribuição
acumulada é dada por

$$
F_G(t;a,b) = \text{exp}\left\{- \text{exp} \left(-\frac{t-\mu}{\beta} \right) \right\},
$$

em que $\mu$ e $\beta$ são os parâmetros de locação e escala análogos à
média e desvio padrão da normal.

Para confirmar que a Gumbel é uma melhor aproximação para a distribuição
amostral do máximo, será conduzido um estudo de simulação semelhante ao
descrito previamente para a distribuição Normal, exceto que, neste caso,
os quantis da distribuição amostral serão comparados com os quantis
teóricos da Gumbel padrão ($\mu = 0, \beta = 1$), que são dados por

$$
F_G^{-1}(i/(n+1)) = -\text{log}(-\text{log}(i/(n+1)))
$$

## 2. Experimentos computacionais

#### Análise do comportamento das distribuições amostrais do máximo para amostras normais padrão de tamanho n = 10, n = 100, n = 1000 e n = 10000

```{r, error=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
# Pacotes 
require(ggplot2)
require(nortest)

# Definindo a semente para garantir reprodutibilidade
set.seed(123)

# Tamanhos de amostra
tam_ams <- c(10, 100, 1000, 10000)

# Número de repetições
reps <- 1000

# Armazenamento
maximos <- list()

for (n in tam_ams) {
  maximos[[as.character(n)]] <- replicate(reps, max(rnorm(n)))
}

# Histograma das distribuições amostrais
par(mfrow = c(2, 2))
for (n in tam_ams) {
  hist(maximos[[as.character(n)]], main = paste("n =", n), ylab = "Densidade",
       xlab = "Máximo", probability = TRUE)
}
```

```{r, error=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
# Verificando a normalidade das distribuições
par(mfrow = c(2, 2))
for (n in tam_ams) {
  dados <- maximos[[as.character(n)]]
  hist(dados, main = paste("n =", n), xlab = "Máximo", ylab = "Densidade",
       probability = TRUE)
  media <- mean(dados)
  desvio <- sd(dados)
  curve(dnorm(x, media, desvio), col = "red", lwd = 2, add = TRUE)
}

# Verificando normalidade via teste de Anderson-Darling
for (n in tam_ams) {
  cat("Teste de Anderson-Darling para n =", n, "\n")
  dados <- maximos[[as.character(n)]]
  result <- ad.test(dados)
  print(result)
   if (result$p.value < 0.05) {
    cat("Rejeita-se a normalidade\n\n")
  } else {
    cat("Não se rejeita a normalidade\n\n")
  }
}
```

#### Qq-plots da Normal

```{r, error=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
# QQ-plots
par(mfrow = c(2, 2))
for (n in tam_ams) {
  qqnorm(maximos[[as.character(n)]], main = paste("n =", n), 
         xlab = "Quantis teóricos", ylab = "Quantis amostrais")
  qqline(maximos[[as.character(n)]], col = "red", lwd = 2)
}
```

#### Simulações com a distribuição de Gumbel

```{r, error=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
# Função para gerar QQ-plot de Gumbel e ajustar reta
qqplot_gumbel <- function(x, y) {
  dados_ord <- sort(x)
  n <- length(dados_ord)
  # Quantis teóricos da Gumbel
  p <- (1:n) / (n + 1)
  quantis_gumbel <- -log(-log(p))
  # Ajuste linear
  ajuste <- lm(dados_ord ~ quantis_gumbel)
  # Estimativas do parâmetro da Gumbel
  beta <- coef(ajuste)[2]
  mi <- coef(ajuste)[1]
  # Gráfico
  plot(quantis_gumbel, dados_ord,
       main = paste("n =", y),
       xlab = "Quantis teóricos",
       ylab = "Quantis amostrais",
       pch = 20, col = "black")
  abline(ajuste, col = "red", lwd = 2)
  legend("topleft",
         legend = paste("μ ≈", round(mi, 2), "\nβ ≈", round(beta, 2)),
         bty = "n")
}

# Gráficos QQ-plot de Gumbel
par(mfrow = c(2, 2))
for (n in tam_ams) {
  dados <- maximos[[as.character(n)]]
  qqplot_gumbel(dados, n)
}
```

#### Estimativas para os parâmetros $\mu$ e $\beta$ da distribuição de Gumbel

Os parâmetros $\mu$ e $\beta$ para cada tamanho de amostra podem ser
estimados pelo **intercepto** e pela **inclinação** da reta do gráfico
quantil-quantil, respectivamente. Estes parâmetros são calculados com
base na regressão linear dos máximos amostrais ordenados em função dos
quantis correspondentes da distribuição Gumbel padrão.

```{r, error=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
qqgumbel <- -log(-log(1:reps/(reps+1)))

lm(sort(maximos[[1]]) ~ qqgumbel)
lm(sort(maximos[[2]]) ~ qqgumbel)
lm(sort(maximos[[3]]) ~ qqgumbel)
lm(sort(maximos[[4]]) ~ qqgumbel)

## Alternativamente

for (i in 1:length(maximos)) {
  param <- lm(sort(maximos[[i]]) ~ qqgumbel)
  cat("n =", as.numeric(names(maximos[i])) ,"\nmu =", param[[1]][[1]], "\nbeta =", param[[1]][[2]], "\n\n")
}
```

## 3. Discussão e conclusões
